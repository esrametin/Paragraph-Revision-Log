<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Paragraph Revision Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Optional: Add a subtle focus effect for inputs/textareas */
        textarea:focus, input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(21, 101, 192, 0.5);
            border-color: #1565C0;
        }
        /* Style for the table input fields */
        .table-input {
            width: 100%;
            min-height: 4rem; /* Ensure enough space for typing */
            padding: 0.5rem;
            border: 1px solid #E5E7EB;
            border-radius: 0.375rem;
            resize: vertical;
        }
    </style>
    <script type="module">

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging
        setLogLevel('Debug');

        // --- GLOBAL FIREBASE VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const firebaseConfig = {
              apiKey: "AIzaSyAY8YOWBS3-ySS6QwXmZIj7aSkBWHevvj4",
              authDomain: "paragraph-revision-log.firebaseapp.com",
              projectId: "paragraph-revision-log",
              storageBucket: "paragraph-revision-log.firebasestorage.app",
              messagingSenderId: "919395799866",
              appId: "1:919395799866:web:a4d328a49d3a69a38bb603",
              measurementId: "G-H7MPSKHCC3"
            };
        
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 1. Authentication Setup
            async function authenticate() {
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    // Fallback to anonymous sign-in or handle failure
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Anonymous Sign-In Failed:", e);
                    }
                }
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
                    isAuthReady = true;
                    console.log("Authentication complete. User ID:", userId);
                    loadProgress(); // Attempt to load saved data
                } else {
                    userId = crypto.randomUUID(); // Fallback if auth completely fails
                    document.getElementById('userIdDisplay').textContent = `User ID (Fallback): ${userId}`;
                    isAuthReady = true;
                    console.log("Authentication complete. Using fallback ID:", userId);
                }
            });

            authenticate();
        } else {
            console.error("Firebase configuration is missing.");
            userId = crypto.randomUUID();
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('userIdDisplay').textContent = `Firebase Not Configured. Fallback ID: ${userId}`;
            });
        }
        
        // Function to extract all form data
        function collectFormData() {
            const decisionRows = Array.from(document.querySelectorAll('#decisionTableBody .decision-row'));
            
            const decisions = decisionRows.map(row => {
                const selects = row.querySelectorAll('select');
                const textareas = row.querySelectorAll('textarea');
                
                return {
                    aspect: selects[0] ? selects[0].value : null,
                    suggestion: textareas[0] ? textareas[0].value : '',
                    decision: selects[1] ? selects[1].value : null,
                    rationale: textareas[1] ? textareas[1].value : '',
                };
            }).filter(d => d.suggestion || d.rationale); // Only save meaningful rows

            return {
                studentName: document.getElementById('studentName').value,
                // Removed: date
                topic: document.getElementById('topic').value,
                draftV1: document.getElementById('draftV1').value,
                aiFeedback: document.getElementById('aiFeedback').value,
                finalDraftV2: document.getElementById('draftV2').value,
                decisions: decisions,
                timestamp: Timestamp.now(),
                userId: userId
            };
        }

        // --- Core Save Function ---
        window.saveProgress = async function() {
            if (!isAuthReady || !db || !userId) {
                const status = document.getElementById('saveStatus');
                status.textContent = 'Status: Waiting for authentication... Please try again shortly.';
                status.className = 'text-yellow-600 mt-2 font-medium';
                return;
            }

            const data = collectFormData();
            const studentNameValue = document.getElementById('studentName').value.trim();
            const logId = studentNameValue.replace(/\s/g, '-') || crypto.randomUUID(); // Use student name or fallback to UUID if blank
            const logDocRef = doc(db, `artifacts/${appId}/users/${userId}/revision_logs`, logId);

            const status = document.getElementById('saveStatus');
            status.textContent = 'Status: Saving...';
            status.className = 'text-blue-600 mt-2 font-medium';

            try {
                await setDoc(logDocRef, data);
                status.textContent = 'Status: Successfully Saved! Time: ' + new Date().toLocaleTimeString();
                status.className = 'text-green-600 mt-2 font-medium';
                console.log("Document successfully written with ID:", logId);
            } catch (e) {
                status.textContent = 'Status: Save Failed! See console for error.';
                status.className = 'text-red-600 mt-2 font-medium';
                console.error("Error writing document: ", e);
            }
        }
        
        // --- Load Progress Function (Placeholder for future development) ---
        async function loadProgress() {
            if (!isAuthReady || !db || !userId) return;
        }
        
        // List of all feedback aspects
        const aspectOptions = [
            "Relevance/Task",
            "Organization/Structure",
            "Development/Detail",
            "Unity/Coherence",
            "Syntactic Variety",
            "Lexical Range/Idiomaticity",
            "Grammar/Clarity"
        ];
        
        // --- Utility Functions for dynamic rows ---
        window.addRow = function(preselectedValue) {
            const tableBody = document.getElementById('decisionTableBody');
            tableBody.appendChild(createRowTemplate(preselectedValue));
        }

        window.removeLastRow = function() {
            const tableBody = document.getElementById('decisionTableBody');
            const rows = tableBody.getElementsByClassName('decision-row');
            if (rows.length > aspectOptions.length) { // Allow removing rows only if count exceeds the default seven
                tableBody.removeChild(rows[rows.length - 1]);
            }
        }

        function createRowTemplate(preselectedValue = aspectOptions[0]) {
            const row = document.createElement('tr');
            row.className = 'decision-row';
            
            // Build Aspect Select Options
            let aspectSelectOptions = aspectOptions.map(aspect => 
                `<option value="${aspect}" ${aspect === preselectedValue ? 'selected' : ''}>${aspect}</option>`
            ).join('');
            
            row.innerHTML = `
                <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    <select class="block w-full py-2 px-1 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        ${aspectSelectOptions}
                    </select>
                </td>
                <td class="px-3 py-4">
                    <textarea class="table-input" rows="3" placeholder="Summarize the specific suggestion here (e.g., AI suggested correcting the transition word 'but' to 'however')."></textarea>
                </td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                    <select class="block w-full py-2 px-1 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="Accepted">Accepted</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </td>
                <td class="px-3 py-4">
                    <textarea class="table-input" rows="3" placeholder="Explain your thinking (e.g., I accepted the change because 'however' provides a stronger academic contrast)."></textarea>
                </td>
            `;
            return row;
        }

        // --- DOM Content Loaded: Initialize 7 default rows ---
        document.addEventListener('DOMContentLoaded', () => {
            const tableBody = document.getElementById('decisionTableBody');
            // Clear default rows first if they existed (in case of dynamic loading issues)
            tableBody.innerHTML = ''; 
            
            // Add one row for each required aspect
            aspectOptions.forEach(aspect => {
                tableBody.appendChild(createRowTemplate(aspect));
            });
        });

    </script>
</head>
<body class="bg-gray-50 p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <header class="mb-8 border-b-4 border-indigo-500 pb-4">
            <h1 class="text-3xl font-bold text-gray-800">Academic Paragraph Revision Log</h1>
            <p class="text-gray-500 mt-2">Data-Driven Writing Cycle: Documenting AI Feedback and Critical Revision</p>
            <p id="userIdDisplay" class="text-xs text-gray-400 mt-1"></p>
        </header>

        <!-- Metadata Section -->
        <section class="space-y-4 mb-8">
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label for="studentName" class="block text-sm font-medium text-gray-700">Student Name:</label>
                    <input type="text" id="studentName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="Jane Doe">
                </div>
            </div>
            <div>
                <label for="topic" class="block text-sm font-medium text-gray-700">Topic:</label>
                <input type="text" id="topic" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g., Online vs. Face-to-Face Education">
            </div>
            <p class="text-sm text-gray-600">
                **Paragraph Goal:** To write a single, unified paragraph that compares and contrasts [Aspect A] and [Aspect B] regarding the topic.
            </p>
        </section>

        <!-- 1. Initial Paragraph Draft (V1) -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">1. Initial Paragraph Draft (V1)</h2>
            <p class="text-sm text-gray-600 mb-2">Write your final draft here into this textbox, without any AI help.</p>
            <textarea id="draftV1" rows="8" class="block w-full border border-gray-300 rounded-md shadow-sm p-3 resize-y"></textarea>
        </section>

        <!-- 2. AI Feedback Analysis -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">2. AI Feedback Analysis</h2>
            <h3 class="text-lg font-medium text-gray-700 mb-2">2B. AI Feedback Received</h3>
            <p class="text-sm text-gray-600 mb-2">*Copy and paste the full feedback generated by the AI here.*</p>
            <textarea id="aiFeedback" rows="10" class="block w-full border border-gray-300 rounded-md shadow-sm p-3 resize-y"></textarea>
        </section>

        <!-- 3. Revision Decisions and Rationale -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">3. Revision Decisions and Rationale</h2>
            <p class="text-sm text-indigo-600 mb-4 font-medium">
                *Instruction: If the AI provided multiple distinct suggestions for a single aspect (e.g., two different grammatical errors or two separate collocation issues), please duplicate the relevant row to log each decision separately.*
            </p>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Aspect of Feedback</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">Summary of AI Suggestion (What was the feedback?)</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Decision</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">Rationale for Decision (Why Accepted/Rejected?)</th>
                        </tr>
                    </thead>
                    <tbody id="decisionTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Default Rows are now dynamically generated by JavaScript for all 7 aspects on DOMContentLoaded -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 flex justify-end space-x-3">
                <button onclick="addRow()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    + Add Decision Row
                </button>
                <button onclick="removeLastRow()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    - Remove Last Row
                </button>
            </div>
        </section>

        <!-- 4. Final Revised Paragraph (V2) -->
        <section>
            <h2 class="text-xl font-semibold text-gray-800 mb-2">4. Final Revised Paragraph (V2)</h2>
            <p class="text-sm text-gray-600 mb-2">*Copy and paste the final, revised version of your paragraph here after incorporating your accepted changes.*</p>
            <textarea id="draftV2" rows="8" class="block w-full border border-gray-300 rounded-md shadow-sm p-3 resize-y"></textarea>
        </section>

        <!-- Save Button and Status -->
        <div class="mt-8 pt-4 border-t border-gray-200 flex flex-col items-end">
            <button onclick="saveProgress()" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                Submit & Save Progress
            </button>
            <p id="saveStatus" class="mt-2 text-sm text-gray-500">Status: Ready to save.</p>
        </div>
        
    </div>

</body>
</html>
